name: Meta Activity Tracker

on:
  schedule:
    - cron: '0 */12 * * *'
  workflow_dispatch:
    inputs:
      hours:
        description: 'Hours to fetch (leave blank for smart auto-detect)'
        required: false
        default: '12'
        type: number

permissions:
  contents: read

jobs:
  fetch-meta-activities:
    name: Fetch Meta Activities
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: ๐ฅ Checkout
      uses: actions/checkout@v4
    
    - name: ๐ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ๐ฆ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ๐ Setup Google Credentials
      run: |
        echo '${{ secrets.GOOGLE_CREDENTIALS_JSON }}' > google_credentials.json
    
    - name: ๐ Run Tracker with Smart Fetch
      run: |
        export META_ACCESS_TOKEN="${{ secrets.META_ACCESS_TOKEN }}"
        export AIRTABLE_TOKEN="${{ secrets.AIRTABLE_TOKEN }}"
        export AIRTABLE_BASE_ID="${{ secrets.AIRTABLE_BASE_ID }}"
        export AIRTABLE_TABLE_NAME="${{ secrets.AIRTABLE_TABLE_NAME }}"
        export GOOGLE_CREDENTIALS_PATH="./google_credentials.json"
        export GOOGLE_SPREADSHEET_ID="${{ secrets.GOOGLE_SPREADSHEET_ID }}"
        export GITHUB_RUN_NUMBER="${{ github.run_number }}"
        
        HOURS=${{ github.event.inputs.hours || '12' }}
        
        echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
        echo "๐ META ACTIVITY TRACKER - RUN #${{ github.run_number }}"
        echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
        echo "โฐ Start time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo "๐ Initial fetch window: ${HOURS} hours"
        echo "๐ Smart fetch: Will auto-adjust based on last entry"
        echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
        
        python fetch_active_brands.py $HOURS
        
        EXIT_CODE=$?
        echo ""
        echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
        if [ $EXIT_CODE -eq 0 ]; then
          echo "โ TRACKER COMPLETED SUCCESSFULLY"
          echo "โฐ End time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "๐ Check Google Sheet for updated data"
        else
          echo "โ TRACKER FAILED"
        fi
        echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
        
        exit $EXIT_CODE
    
    - name: ๐ค Upload Logs on Failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: failure-logs-run-${{ github.run_number }}
        path: |
          *.log
          *.csv
        retention-days: 7
    
    - name: ๐งน Cleanup
      if: always()
      run: rm -f google_credentials.json
